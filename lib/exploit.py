#!/usr/bin/env python3

import requests

from datetime import datetime
from src import color as C
from lib import user_agent as UA


def Finder(args):
    # Handling and preparing the args.url.
    if args.url[:7] != "http://" and args.url[:8] != "https://":
        args.url = "http://" + args.url
    if args.url[-1] != "/":
        args.url = args.url + "/"

    print("{}[+]{} Target: {}".format(C.GREEN, C.RESET, args.url))

    # Select proxy protocol.
    if args.proxy != False:
        if args.url[:7] == "http://":
            args.proxy = {'http://': args.proxy}
        elif args.url[:7] == "https://":
            args.proxy = {'https://': args.proxy}
        elif args.url[:7] == "ftp":
            args.proxy = {'ftp': args.proxy}
        else:
            args.proxy = ""

    # Generates a random user agent.
    if args.user_agent == False:
        UserAgent = UA.Random()
        print(
            "{}[+]{} Random User-Agent Generated: {}".format(C.GREEN, C.RESET, UserAgent))
    # Selects a User-Agent.
    elif args.user_agent != False:
        UserAgent = args.user_agent
        print("{}[+]{} User-Agent selected: {}".format(C.GREEN, C.RESET, UserAgent))

    # Make the request from the target site.
    try:
        headers = {'User-Agent': UserAgent}
        r = requests.get(args.url + "/", proxies=args.proxy, headers=headers)
    except Exception:
        print("\n{}[!]{} ERROR! Targeted site reported is offline.".format(
            C.RED, C.RESET))
        exit()

    # Configures the selected Wordlist.
    if args.wordlist == "1":
        WList = open('extra/wordlists/small.txt', 'r')
        print("{}[+]{} Wordlist 'Small' selected.".format(C.GREEN, C.RESET))
    elif args.wordlist == "2":
        WList = open('extra/wordlists/medium.txt', 'r')
        print("{}[+]{} Wordlist 'Medium' selected.".format(C.GREEN, C.RESET))
    elif args.wordlist == "3":
        WList = open('extra/wordlists/big.txt', 'r')
        print("{}[+]{} Wordlist 'Big' selected.".format(C.GREEN, C.RESET))
    else:
        WList = open(args.wordlist)
        print("{}[+]{} Wordlist '{}' selected.".format(C.GREEN,
                                                       C.RESET, args.wordlist))

    print("\n{}{}[!] Starting Exploit Finder.{}\n".format(
        C.BOLD, C.GREEN, C.RESET))
    Links = WList.readlines()

    # Finder Execution.
    for Link in Links:
        try:
            target = args.url + Link.rstrip("\n")
            r = requests.get(target, proxies=args.proxy, headers=headers)
            if r.status_code == 200:
                print("{}{}[FOUND!]{} {}{}".format(
                    C.BOLD, C.GREEN, C.RESET, args.url, Link.rstrip('\n')))
            else:
                print("{}[-]{} {}{}".format(C.RED, C.RESET,
                                            args.url, Link.rstrip('\n')))
        except KeyboardInterrupt:
            try:
                print(
                    "\n{}[!]{} 'CTRL + C' has been pressed.".format(C.RED, C.RESET))
                OPC = input("Do you want to close Heimdall? [y/N] ")
                if OPC == "Y" or OPC == "y":
                    print("{}[+]{} Finished!  Date: {} Time: {}".format(C.GREEN, C.RESET,
                                                                        datetime.now().strftime("%m/%d/%Y"), datetime.now().strftime("%H:%M")))
                    print("{}[!]{} Script has been successfully terminated!".format(
                        C.GREEN, C.RESET))
                    exit()
                elif OPC == "N" or OPC == "n":
                    continue
            except KeyboardInterrupt:
                print("\n\n{}[+]{} Finished!  Date: {} Time: {}".format(C.GREEN, C.RESET,
                                                                        datetime.now().strftime("%m/%d/%Y"), datetime.now().strftime("%H:%M")))
                exit()
    print("\n{}[+]{} Finished!  Date: {} Time: {}".format(C.GREEN, C.RESET,
                                                          datetime.now().strftime("%m/%d/%Y"), datetime.now().strftime("%H:%M")))
